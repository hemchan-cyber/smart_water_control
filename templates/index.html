<!DOCTYPE html>
<html>
<head>
  <title>Dashboard | Smart Water Controller</title>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- PWA Manifest -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <meta name="theme-color" content="#2196f3">
    <!-- iOS Support -->
  <link rel="apple-touch-icon" href="/static/logo.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <style>

#user-dp {
  transition: transform 0.2s ease;
}
#user-dp:hover {
  transform: scale(1.1);
  cursor: pointer;
}
body {
  margin: 0;
  font-family: 'Segoe UI', sans-serif;
  background: url('static/das.jpeg') no-repeat center center fixed;
  background-size: cover;
  background-attachment: fixed;
  min-height: 100vh;
  transition: background-position 0.3s ease-in-out;
}

.overlay {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  min-height: 100%;
  background-color: rgba(0, 0, 0, 0.5); /* slightly stronger opacity */
  z-index: -1;
}
html {
  scroll-behavior: smooth;
}

.section h1, .section p {
  transition: transform 0.3s ease, opacity 0.5s ease;
}

.section:hover h1 {
  transform: translateY(-5px);
  opacity: 0.9;
}
html, body {
  height: 100%;
  margin: 0;
  display: flex;
  flex-direction: column;
}
.card {
  background: rgba(0, 0, 0, 0.5); /* dark glass */
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: #ffffff;
}
main {
  flex: 1;
  position: relative;
}

.footer {
  background: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(5px);
  color: white;
  width: 100%;
}
.modal-backdrop.show {
  backdrop-filter: blur(5px);
  background-color: rgba(0, 0, 0, 0.5);
}

</style>
</head>
<body>
<main class="flex-grow-1 position-relative">
  <div class="overlay"></div>
  <div class="container mt-5">
<div class="d-flex justify-content-between align-items-center mb-4">
  <div class="d-flex align-items-center">
    <img src="static/logo.png" alt="Logo" width="40" height="40" class="me-2" style="box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); border-radius: 10px;">
    <h2 class="mb-0" style="color: #fff; text-shadow: 2px 2px 5px rgba(0,0,0,0.7);">Smart Water Dashboard</h2>
  </div>

  <div class="dropdown">
    <a href="#" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
      <img id="user-dp" src="" alt="User DP" class="rounded-circle" width="40" height="40" style="object-fit: cover;">
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
      <li><span class="dropdown-item-text" id="user-email-display">Loading...</span></li>
      <li><hr class="dropdown-divider"></li>
      <li><a class="dropdown-item text-danger" href="#" onclick="logout()">üö™ Logout</a></li>
    </ul>
  </div>
</div>

<!-- Logged-in User Info -->
<div class="mb-4">
  <p style="color: #eee; text-shadow: 1px 1px 3px rgba(0,0,0,0.6);">üë§ Logged in as: <span id="current-user-name">Loading...</span> (<code id="current-user-uid">...</code>)</p>
</div>

<!-- Authorized Users (Visible to Admins Only) -->
<div id="authorized-users-section" class="card mb-4" style="display: none;">
  <div class="card-body">
    <h5 class="card-title">Authorized Users (Admin Access Only)</h5>

    <table class="table table-bordered">
      <thead>
        <tr>
          <th>UID</th>
          <th>Role</th>
          <th>Remove</th>
        </tr>
      </thead>
      <tbody id="authorized-users-table"></tbody>
    </table>

    <div class="input-group mt-3">
      <input id="new-user-uid" class="form-control" placeholder="Enter UID ">
      <select id="new-user-role" class="form-select">
        <option value="viewer">Viewer</option>
        <option value="admin">Admin</option>
      </select>
      <button class="btn btn-primary" onclick="addAuthorizedUser()">‚ûï Add User</button>
    </div>
  </div>
</div>

  <!-- Tank Configuration -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Tank Settings & Water Level</h5>

      <div class="form-check form-switch mb-3">
        <input class="form-check-input" type="checkbox" id="ultrasonicToggle">
        <label class="form-check-label" for="ultrasonicToggle">Enable Ultrasonic Monitoring</label>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <label for="tankDepth" class="form-label">Tank Depth (in cm)</label>
          <input type="number" class="form-control" id="tankDepth" placeholder="Tank Depth (cm)">
        </div>
        <div class="col-md-6">
          <label for="tankFullDistance" class="form-label">Distance from Sensor to Full Level (in cm)</label>
          <input type="number" class="form-control" id="tankFullDistance" placeholder="Distance from sensor to full level (cm)">
        </div>
      </div>

      <button class="btn btn-primary" onclick="saveTankSettings()">üíæ Save Tank Settings</button>
      <p class="mt-3">Water Level: <span id="water-level">Loading...</span></p>

      <div class="progress" style="height: 25px;">
        <div id="water-progress" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
          0%
        </div>
      </div>
      <div id="water-warning" class="text-danger fw-bold mt-2"></div>
    </div>
  </div>

<!-- Manual Relay Control -->
<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title">Relay Control</h5>
    <button class="btn btn-success me-2" onclick="setRelay('on')">Turn ON</button>
    <button class="btn btn-secondary" onclick="setRelay('off')">Turn OFF</button>
    <p class="mt-3">Current Status: <span id="relay-status">Loading...</span></p>
    <p id="relay-countdown" class="text-muted small"></p>
  </div>
</div>


  <!-- Schedule Controls -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Schedule Irrigation</h5>
      <div id="schedule-list"></div>
      <button class="btn btn-success my-2" onclick="addScheduleBlock()">‚ûï Add Schedule</button>
      <button class="btn btn-primary" onclick="saveSchedules()">üíæ Save All</button>
      <button class="btn btn-danger" onclick="clearAllSchedules()">üßπ Clear All</button>
    </div>
  </div>

  <div class="card mb-4" id="user-management" style="display: none;">
  <div class="card-body">
    <h5 class="card-title">User Management (Admins only)</h5>
    <input type="text" id="newUserUid" class="form-control mb-2" placeholder="New User UID">
    <select id="newUserRole" class="form-select mb-2">
      <option value="viewer">Viewer</option>
      <option value="admin">Admin</option>
    </select>
    <button class="btn btn-success" onclick="addNewUser()">‚ûï Add User</button>
  </div>
</div>

</div>
</div>
</main>

<footer class="footer mt-auto py-3 text-center text-light">
  <div class="container">
    <p class="mb-0 small">
      üå± Smart Water Controller Dashboard &nbsp; | &nbsp;
      Created in 2025 by <strong>HEM'S ART</strong> üíª
    </p>
    <p   style="color:  #ffffff; text-shadow: 1px 1px 3px rgba(0,0,0,0.6);">Inspired by modern smart farming applications.</p>
  </div>
</footer>
<!-- Custom Modal -->
<div id="customModal" class="modal fade" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-dark">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Message</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modalBody">Message content here...</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>
<!-- Confirmation Modal -->
<div id="confirmModal" class="modal fade" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-dark">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalTitle">Confirm</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="confirmModalBody">Are you sure?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelConfirm">Cancel</button>
        <button type="button" class="btn btn-primary" id="okConfirm">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase Script -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
  import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
  const userRole = localStorage.getItem('userRole') || "viewer"; // Default to viewer

  function showModal(message, title = "Alert") {
  document.getElementById("modalTitle").innerText = title;
  document.getElementById("modalBody").innerText = message;
  const modal = new bootstrap.Modal(document.getElementById("customModal"));
  modal.show();
  }
  function showConfirmation(message, title = "Please Confirm") {
    return new Promise((resolve) => {
      document.getElementById("confirmModalTitle").innerText = title;
      document.getElementById("confirmModalBody").innerText = message;

      const modalElement = document.getElementById("confirmModal");
      const modal = new bootstrap.Modal(modalElement);

      // Attach event listeners
      document.getElementById("okConfirm").onclick = () => {
        modal.hide();
        resolve(true);
      };
      document.getElementById("cancelConfirm").onclick = () => {
        modal.hide();
        resolve(false);
      };

      modal.show();
    });
  }

  if (userRole === "admin") {
  document.getElementById("user-management").style.display = "block";

  window.addNewUser = function () {
    const uid = document.getElementById("newUserUid").value.trim();
    const role = document.getElementById("newUserRole").value;

    if (!uid) return showModal("‚ö†Ô∏è Enter a valid UID");

    const userRef = ref(db, `authorized_users/${uid}`);
    set(userRef, role)
      .then(() => showModal(`‚úÖ Added user with role: ${role}`))
      .catch(err => showModal(`‚ùå Failed: ${err.message}`));
  };
}

  const firebaseConfig = {
    apiKey: "AIzaSyDCFJU9FVFcTpFJYTs2PCtZ2o5scVj83jw",
    authDomain: "smartrose-app-9be54.firebaseapp.com",
    databaseURL: "https://smartrose-app-9be54-default-rtdb.firebaseio.com",
    projectId: "smartrose-app-9be54",
    storageBucket: "smartrose-app-9be54.appspot.com",
    messagingSenderId: "107092876388",
    appId: "1:107092876388:web:5b215f0fe0250c28e21371"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const deviceId = "demo-device";

  window.logout = function () {
    signOut(auth).then(() => {
      localStorage.removeItem('user');
      window.location.href = "/";
    }).catch(error => console.error("Logout failed:", error));
  };

onAuthStateChanged(auth, user => {
  if (!user) return window.location.href = "/";

  const uid = user.uid;
  const name = user.displayName || user.email || "Unknown";
  const photo = user.photoURL || "https://www.gravatar.com/avatar/?d=mp"; // fallback DP
  const email = user.email || "Unknown";

  document.getElementById("current-user-name").innerText = name;
  document.getElementById("current-user-uid").innerText = uid;
  document.getElementById("user-dp").src = photo;
  document.getElementById("user-email-display").innerText = email;

  const userRef = ref(db, `authorized_users/${uid}`);
  get(userRef).then((snap) => {
    const role = snap.val();

    if (!role) {
      showModal("üö´ You are not authorized to access this dashboard.");
      signOut(auth);
      return (window.location.href = "/");
    }

    if (role === "admin") {
      document.getElementById("user-management").style.display = "block";
      document.getElementById("authorized-users-section").style.display = "block";

      // Load authorized user table
      onValue(ref(db, "authorized_users"), (snap) => {
        const table = document.getElementById("authorized-users-table");
        table.innerHTML = "";
        const users = snap.val() || {};
        for (const [uid, role] of Object.entries(users)) {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${uid}</td>
            <td>${role}</td>
            <td>
              ${role === "viewer"
                ? `<button class="btn btn-sm btn-danger" onclick="removeAuthorizedUser('${uid}')">üóëÔ∏è Remove</button>`
                : `<span class="text-muted">üîí Protected</span>`}
            </td>
          `;
          table.appendChild(row);
        }
      });

      window.removeAuthorizedUser = function (uid) {
        const userRef = ref(db, `authorized_users/${uid}`);

        get(userRef).then(snapshot => {
          const role = snapshot.val();
          if (!role) {
            showModal("‚ö†Ô∏è User not found.");
            return;
          }

          if (role === "admin") {
            showModal("üö´ You cannot remove an admin user.");
            return;
          }
          showConfirmation(`Are you sure you want to remove viewer "${uid}"?`)
            .then((confirmed) => {
              if (confirmed) {
            set(userRef, null)
              .then(() => showModal(`üóëÔ∏è Viewer "${uid}" removed successfully.`))
              .catch(err => showModal(`‚ùå Failed to remove: ${err.message}`));
          }
        });
        }).catch(err => {
          showModal("‚ùå Failed to fetch user role: " + err.message);
        });
      };

      // Admin user add function
      window.addAuthorizedUser = function () {
        const newUid = document.getElementById("new-user-uid").value.trim();
        const newRole = document.getElementById("new-user-role").value;
        if (!newUid) return showModal("‚ö†Ô∏è Enter a UID or email");
        set(ref(db, `authorized_users/${newUid}`), newRole)
          .then(() => {
            showModal(`‚úÖ ${newUid} added as ${newRole}`);
            document.getElementById("new-user-uid").value = "";
          })
          .catch((err) => showModal("‚ùå Failed: " + err.message));
      };

      window.addNewUser = function () {
        const newUid = document.getElementById("newUserUid").value.trim();
        const newRole = document.getElementById("newUserRole").value;
        if (!newUid) return showModal("‚ö†Ô∏è Enter a UID");
        set(ref(db, `authorized_users/${newUid}`), newRole)
          .then(() => showModal(`‚úÖ User ${newUid} added as ${newRole}`))
          .catch((err) => showModal("‚ùå Failed: " + err.message));
      };
    } else {
      // Disable buttons for viewers
      document.querySelectorAll("button").forEach((btn) => {
        const text = btn.innerText.toLowerCase();
        if (
          text.includes("turn on") ||
          text.includes("turn off") ||
          text.includes("save tank") ||
          text.includes("add schedule") ||
          text.includes("save all") ||
          text.includes("clear all") ||
          text.includes("add user")
        ) {
          btn.disabled = true;
        }
      });
    }

    // ‚úÖ Now we initialize the actual dashboard
    initializeDashboard();
  });
});

function updateRelayStatusDisplay(status) {
  const label = document.getElementById("relay-status");

  if (status === "on" && window.relayMode === "scheduled") {
    label.innerText = "ON (Scheduled)";
  } else if (status === "on") {
    label.innerText = "ON (Manual)";
  } else {
    label.innerText = "OFF";
    document.getElementById("relay-countdown").innerText = "";
  }
}

function initializeDashboard() {
  const deviceRef = ref(db, `devices/${deviceId}`);
  const relayRef = ref(db, `devices/${deviceId}/relay_status`);
  const relayModeRef = ref(db, `devices/${deviceId}/relay_mode`);
  const scheduleEndRef = ref(db, `devices/${deviceId}/schedule_end`);
  const scheduleRef = ref(db, `devices/${deviceId}/schedules`);

  onValue(deviceRef, snapshot => {
    const data = snapshot.val() || {};
    const ultrasonicEnabled = data.ultrasonic_enabled !== false;
    const tankDepth = data.tank_depth || 0;
    const fullDistance = data.full_distance || 0;
    const waterPercent = data.water_level || 0;

    document.getElementById("ultrasonicToggle").checked = ultrasonicEnabled;
    document.getElementById("tankDepth").value = tankDepth;
    document.getElementById("tankFullDistance").value = fullDistance;

    const waterText = document.getElementById("water-level");
    const warning = document.getElementById("water-warning");
    const progressBar = document.getElementById("water-progress");

    if (ultrasonicEnabled) {
      waterText.innerText = `${waterPercent}%`;
      progressBar.style.width = `${waterPercent}%`;
      progressBar.setAttribute("aria-valuenow", waterPercent);
      progressBar.innerText = `${waterPercent}%`;

      if (waterPercent <= 10) {
        progressBar.className = "progress-bar bg-danger";
        warning.innerText = "‚ùå Water too low!";
      } else if (waterPercent <= 30) {
        progressBar.className = "progress-bar bg-warning text-dark";
        warning.innerText = "‚ö†Ô∏è Very low water level!";
      } else if (waterPercent <= 50) {
        progressBar.className = "progress-bar bg-info";
        warning.innerText = "‚ö†Ô∏è Water at 50%. Please refill soon.";
      } else {
        progressBar.className = "progress-bar bg-success";
        warning.innerText = "";
      }
    } else {
      waterText.innerText = "üîá Monitoring Disabled";
      progressBar.style.width = "0%";
      progressBar.className = "progress-bar bg-secondary";
      progressBar.innerText = "Disabled";
      warning.innerText = "";
    }
  });

  let countdownInterval;

  onValue(relayRef, snapshot => {
    const relayStatus = snapshot.val() || "off";
    updateRelayStatusDisplay(relayStatus);
  });

  get(scheduleEndRef).then(snapshot => {
    const endTime = snapshot.val();
    if (window.relayMode === "scheduled" && endTime && Math.floor(Date.now() / 1000) < endTime) {
      startCountdown(endTime);
    }
  });

  onValue(relayModeRef, snapshot => {
    const mode = snapshot.val() || "manual";
    window.relayMode = mode;
  });

  onValue(ref(db, `devices/${deviceId}/remaining_time`), snapshot => {
    const remainingSeconds = snapshot.val();
    if (window.relayMode === "scheduled" && remainingSeconds > 0) {
      startCountdownFromNow(remainingSeconds);
    } else {
      clearInterval(countdownInterval);
      document.getElementById("relay-countdown").innerText = "";
    }
  });

  onValue(scheduleEndRef, snapshot => {
    const endTime = snapshot.val();
    if (window.relayMode === "scheduled" && endTime && Math.floor(Date.now() / 1000) < endTime) {
      startCountdown(endTime);
    } else {
      clearInterval(countdownInterval);
      document.getElementById("relay-countdown").innerText = "";
    }
  });

  onValue(scheduleRef, snapshot => {
    const schedules = snapshot.val();
    const list = document.getElementById("schedule-list");
    list.innerHTML = "";

    if (schedules) {
      Object.entries(schedules).forEach(([key, sch]) => {
        const div = document.createElement("div");
        div.className = "border p-2 mb-2";
        div.innerHTML = `
          <label for="time-${key}" class="form-label">Irrigation Time</label>
          <input type="time" class="form-control mb-1" value="${sch.time}" id="time-${key}">
          <label for="duration-${key}" class="form-label">Duration (in minutes)</label>
          <input type="number" class="form-control mb-1" placeholder="Duration (min)" value="${sch.duration}" id="duration-${key}">
          <label class="form-label">Repeat On</label>
          <div class="dropdown mb-2">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">Repeat</button>
            <ul class="dropdown-menu px-3" id="repeat-days-${key}" style="max-height: 180px; overflow-y: auto; overflow-x: hidden;">
              ${["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].map(day => `
                <li><input type="checkbox" class="form-check-input me-1" id="${day}-${key}" ${sch.repeat?.includes(day) ? 'checked' : ''}> ${day}</li>`).join("")}
              <li><hr></li>
              <li><button class="btn btn-sm btn-secondary w-100" onclick="selectAllDays('${key}')">Select All</button></li>
            </ul>
          </div>
          <div class="form-check mb-2">
            <input type="checkbox" class="form-check-input" ${sch.active ? 'checked' : ''} id="active-${key}">
            <label class="form-check-label" for="active-${key}">Active</label>
          </div>
          <button class="btn btn-sm btn-danger mt-2" onclick="deleteSchedule('${key}')">üóëÔ∏è Delete</button>
        `;
        list.appendChild(div);
      });
    }
  });
}


  window.setRelay = (status) => {
    set(ref(db, `devices/${deviceId}/relay_status`), status);
  };

  window.saveTankSettings = function () {
    const depth = parseFloat(document.getElementById("tankDepth").value);
    const fullDistance = parseFloat(document.getElementById("tankFullDistance").value);
    const ultrasonicEnabled = document.getElementById("ultrasonicToggle").checked;

    if (isNaN(depth) || isNaN(fullDistance) || depth <= 0 || fullDistance < 0 || fullDistance >= depth) {
      showModal("‚ö†Ô∏è Please enter valid tank settings.");
      return;
    }

    update(ref(db, `devices/${deviceId}`), {
      tank_depth: depth,
      full_distance: fullDistance,
      ultrasonic_enabled: ultrasonicEnabled
    }).then(() => showModal("‚úÖ Tank settings saved!"));
  };

  window.selectAllDays = function (id) {
    ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].forEach(day => {
      document.getElementById(`${day}-${id}`).checked = true;
    });
  };

  window.addScheduleBlock = function () {
  const id = `sch${Date.now()}`;
  const div = document.createElement("div");
  div.className = "border p-2 mb-2";
  div.innerHTML = `
    <label for="time-${id}" class="form-label">Irrigation Time</label>
    <input type="time" class="form-control mb-1" id="time-${id}">
    <label for="duration-${id}" class="form-label">Duration (in minutes)</label>
    <input type="number" class="form-control mb-1" placeholder="Duration (min)" id="duration-${id}">
    <label class="form-label">Repeat On</label>
    <div class="dropdown mb-2">
      <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">Repeat</button>
      <ul class="dropdown-menu px-3" id="repeat-days-${id}" style="max-height: 180px; overflow-y: auto; overflow-x: hidden;">
        ${["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].map(day => `
          <li><input type="checkbox" class="form-check-input me-1" id="${day}-${id}"> ${day}</li>`).join("")}
        <li><hr></li>
        <li><button class="btn btn-sm btn-secondary w-100" onclick="selectAllDays('${id}')">Select All</button></li>
      </ul>
    </div>
    <div class="form-check mb-2">
      <input type="checkbox" class="form-check-input" id="active-${id}" checked>
      <label class="form-check-label" for="active-${id}">Active</label>
    </div>
    <button class="btn btn-sm btn-danger mt-2" onclick="deleteSchedule('${id}')">üóëÔ∏è Delete</button>
  `;
  document.getElementById("schedule-list").appendChild(div);
};

  window.saveSchedules = function () {
    const blocks = document.getElementById("schedule-list").children;
    const updates = {};
    Array.from(blocks).forEach((block) => {
      const id = block.querySelector("input[type='time']").id.split("-")[1];
      const time = document.getElementById(`time-${id}`).value;
      const duration = parseInt(document.getElementById(`duration-${id}`).value);
      const active = document.getElementById(`active-${id}`).checked;
      const repeat = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].filter(day => {
        const cb = document.getElementById(`${day}-${id}`);
        return cb && cb.checked;
      });
      updates[id] = { time, duration, repeat, active };
    });

    set(ref(db, `devices/${deviceId}/schedules`), updates)
      .then(() => showModal("‚úÖ All schedules saved!"))
      .catch(err => showModal("‚ùå Failed to save: " + err.message));
  };

  window.deleteSchedule = function (key) {
    showConfirmation(`Delete schedule "${key}"?`)
      .then((confirmed) => {
        if (confirmed) {
      set(ref(db, `devices/${deviceId}/schedules/${key}`), null)
        .then(() => showModal(`üóëÔ∏è Schedule "${key}" deleted!`))
        .catch(err =>showModal(`‚ùå Failed: ${err.message}`));
    }
  }
)};

  window.clearAllSchedules = function () {
    showConfirmation("‚ö†Ô∏è Delete ALL schedules?")
      .then((confirmed) => {
        if (confirmed) {
      set(ref(db, `devices/${deviceId}/schedules`), null)
        .then(() => {
          document.getElementById("schedule-list").innerHTML = "";
          showModal("üßπ All schedules cleared.");
        })
        .catch(err => showModal("‚ùå Failed: " + err.message));
    }
    }
  )};
  window.addEventListener('scroll', function () {
    document.body.style.backgroundPositionY = -(window.scrollY * 0.2) + 'px';
  });
  if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/static/service-worker.js')
    .then(function(registration) {
      console.log('Service Worker registered with scope:', registration.scope);
    }).catch(function(error) {
      console.log('Service Worker registration failed:', error);
    });
  }
</script>
</body>
</html>
