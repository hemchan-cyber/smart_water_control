<!DOCTYPE html>
<html>
<head>
<title>Login | Smart Water Controller</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- PWA Manifest -->
<link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
<meta name="theme-color" content="#2196f3">
<style>
.login-box {
    padding: 2rem;
    background: white;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
}
img {
    width: 120px;
    margin-bottom: 20px;
}
</style>
</head>
<body class="d-flex justify-content-center align-items-center vh-100" 
style="background: url('static/log.png') no-repeat center center fixed;
        background-size: cover;">

    <div class="text-center">
        <img src="static/logo.png" alt="Logo" style="box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4); border-radius: 10px;">
        <h1 style="color: #fff; text-shadow: 2px 2px 5px rgba(0,0,0,0.7);">Smart Water Controller</h1>
        <p style="color: #eee; text-shadow: 1px 1px 3px rgba(0,0,0,0.6);">Login securely using Google</p>
        <button class="btn btn-primary" onclick="loginWithGoogle()">üîê Login with Google</button>
    </div>
        <!-- Custom Modal -->
        <div id="customModal" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-dark">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Message</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalBody">Message content here...</div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
            </div>
        </div>
        </div>
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    function showModal(message, title = "Alert") {
        document.getElementById("modalTitle").innerText = title;
        document.getElementById("modalBody").innerText = message;
        const modal = new bootstrap.Modal(document.getElementById("customModal"));
        modal.show();
        }
    const firebaseConfig = {
        apiKey: "AIzaSyDCFJU9FVFcTpFJYTs2PCtZ2o5scVj83jw",
        authDomain: "smartrose-app-9be54.firebaseapp.com",
        databaseURL: "https://smartrose-app-9be54-default-rtdb.firebaseio.com",
        projectId: "smartrose-app-9be54",
        storageBucket: "smartrose-app-9be54.appspot.com",
        messagingSenderId: "107092876388",
        appId: "1:107092876388:web:5b215f0fe0250c28e21371",
        measurementId: "G-KW3GDW1FQB"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    window.loginWithGoogle = () => {
        signInWithPopup(auth, provider)
        .then((result) => {
            const user = result.user;
            const uid = user.uid;

            get(ref(db, `authorized_users/${uid}`)).then(snapshot => {
            const role = snapshot.val();

            if (role) {
                localStorage.setItem('user', JSON.stringify(user));
                localStorage.setItem('userRole', role);
                window.location.href = "/loading";
            } else {
                showModal("‚ùå You are not authorized to access this system.");
                signOut(auth);
            }
            }).catch((err) => {
            console.error("Authorization check failed:", err);
            showModal("‚ö†Ô∏è Authorization check failed.");
            signOut(auth);
            });
        })
        .catch((error) => {
            showModal("Login failed: " + error.message);
            console.error(error);
        });
    };
    if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register("{{ url_for('static', filename='service-worker.js') }}")
    .then(reg => console.log("Service Worker Registered"))
    .catch(err => console.error("SW registration failed", err));
    }
    </script>

</body>
</html>
